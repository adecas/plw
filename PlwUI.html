<!DOCTYPE html>
<meta charset="UTF-8">
<html><head><title>PL/W</title></head><body>

<script src="PlwTokenReader.js"></script>
<script src="PlwAst.js"></script>
<script src="PlwParser.js"></script>
<script src="PlwCompiler.js"></script>
<script src="PlwRefManager.js"></script>
<script src="PlwStackMachine.js"></script>
<script src="PlwNativeFunctionManager.js"></script>
<script src="PlwUI.js"></script>

<input type="button" value="exec" onclick="onExecClick(false)">
<input type="button" value="debug" onclick="onExecClick(true)">
<input type="button" value="eval" onclick="onEvalClick()">
<label for="snippets">Snippets</label><select id="snippets" onchange="onSnippetChange()"><option value=""></option></select><br>
<textarea id="textin" rows="10" cols="100"></textarea><br>
<input type="button" value="clear messages" onclick="onClearMessageClick()">
<input type="button" value="display context" onclick="onDisplayContextClick()">
<input type="button" value="display stack machine" onclick="onDisplayStackMachineClick()">
<input type="button" value="reset context" onclick="onResetContextClick()"><br>
<textarea id="textout" rows="10" cols="100"></textarea><br>
<textarea id="debug" rows="10" cols="100"></textarea>

<p id="snippet-variable-title" class="snippet">Variable</p>
<pre id="snippet-variable">
var i integer := 2 + 3 * 4;
i := i / 2;
print('i = ' || text(i) || ', expected 7');
i := 8 % 3;
print('i = ' || text(i) || ', expected 2');
i := (2 + 3) * 4;
i := 5 - i;
print('i = ' || text(i) || ', expected -15');
var b boolean := true or true and false;
print('b = ' || text(b) || ', expected true');
b := (true or true) and false;
print('b = ' || text(b) || ', expected false');
b := 1 = 2;
print('b = ' || text(b) || ', expected false');
b := 2 = 2;
print('b = ' || text(b) || ', expected true');
b := 1 < 2;
print('b = ' || text(b) || ', expected true');
b := 1 > 2;
print('b = ' || text(b) || ', expected false');
b := 2 < 2;
print('b = ' || text(b) || ', expected false');
b := 2 > 2;
print('b = ' || text(b) || ', expected false');
b := 1 <= 2;
print('b = ' || text(b) || ', expected true');
b := 1 >= 2;
print('b = ' || text(b) || ', expected false');
b := 2 <= 2;
print('b = ' || text(b) || ', expected true');
b := 2 >= 2;
print('b = ' || text(b) || ', expected true');
b := 1 <> 2;
print('b = ' || text(b) || ', expected true');
b := 2 <> 2;
print('b = ' || text(b) || ', expected false');
var t text := 'Hello' || ' ';
t := t || 'World';
print('t = ' || t || ', expected Hello World');
t := subtext(t, 3, 5);
print('t = ' || t || ', expected lo Wo');
</pre>

<p id="snippet-real-title" class="snippet">Real</p>
<pre id="snippet-real">
var i real := 2.2 + 3.3 * 4.4;
i := i / 2.2;
print('i = ' || text(i) || ', expected 7.6');
i := (2.2 + 3.3) * 4.4;
i := 5.5 - i;
print('i = ' || text(i) || ', expected -18.7');
var b boolean := 1.1 = 2.2;
print('b = ' || text(b) || ', expected false');
b := 2.2 = 2.2;
print('b = ' || text(b) || ', expected true');
b := 1.1 < 2.2;
print('b = ' || text(b) || ', expected true');
b := 1.1 > 2.2;
print('b = ' || text(b) || ', expected false');
b := 2.2 < 2.2;
print('b = ' || text(b) || ', expected false');
b := 2.2 > 2.2;
print('b = ' || text(b) || ', expected false');
b := 1.1 <= 2.2;
print('b = ' || text(b) || ', expected true');
b := 1.1 >= 2.2;
print('b = ' || text(b) || ', expected false');
b := 2.2 <= 2.2;
print('b = ' || text(b) || ', expected true');
b := 2.2 >= 2.2;
print('b = ' || text(b) || ', expected true');
b := 1.1 <> 2.2;
print('b = ' || text(b) || ', expected true');
b := 2.2 <> 2.2;
print('b = ' || text(b) || ', expected false');
</pre>

<p id="snippet-flow-control-title" class="snippet">Flow Control</p>
<pre id="snippet-flow-control">
if 2 = 1 + 1 then
  print('Good');
else
  print('Error: alternate reality');
end if;
if not (2 = 1 + 1) then
  print('Error: alternate reality');
end if;
if 2 <> 1 + 1 then
  print('Error: alternate reality');
else
  print('Good');
end if;
if 2 <> 1 + 1 then
  print('Error: alternate reality');
elsif 2 = 1 + 1 then
  print('Good');
else
  print('Error: alternate reality');
end if;
if 2 <> 1 + 1 then
  print('Error: alternate reality');
elsif 4 <> 2 + 2 then
  print('Error: alternate reality');
else
  print('Good');
end if;
print('Done if, 4 Good expected');
var i integer := 10;
while i <= 100 loop
  print(text(i));
  i := i + 10;
end loop;
while i <= 100 loop
  print('Error: alternate reality');
end loop;
print('Done while'); 
</pre>

<p id="snippet-arrays-title" class="snippet">Arrays</p>
<pre id="snippet-arrays">
var a [integer] := [integer: 11, 22, 33, 44, 55];
var b integer := a[1];
var c [integer] := a[2..4];
var d [integer] := c || [integer: 66, 77];
if b = 22 and c = [integer: 33, 44, 55] and d = [integer: 33, 44, 55, 66, 77] then
  print('Good');
else
  print('Error: alternate reality');
end if;
var aa [[integer]] := [[integer]:
  [integer: 11, 12],
  [integer: 22, 23],
  [integer: 33, 34],
  [integer: 44],
  [integer: 55, 56, 57]
];
var bb [integer] := aa[1];
var cc [[integer]] := aa[1..2];
var dd [[integer]] := cc || [[integer]: [integer: 66, 67, 68], [integer:]];
if
  bb = [integer: 22, 23] and
  cc = [[integer]: [integer: 22, 23], [integer: 33, 34]] and
  dd = [[integer]: [integer: 22, 23], [integer: 33, 34], [integer: 66, 67, 68], [integer:]]
then
  print('Good');
else
  print('Error: alternate reality');
end if;
var at [text] := [text: '11', '22', '33', '44', '55'];
var bt text := at[1];
var ct [text] := at[2..3];
var dt [text] := ct || [text: '66', '77'];
if bt = '22' and ct = [text: '33', '44'] and dt = [text: '33', '44', '66', '77'] then
  print('Good');
else
  print('Error: alternate reality');
end if;
</pre>

<p id="snippet-basic-procedure-title" class="snippet">Basic Procedure</p>
<pre id="snippet-basic-procedure">
procedure say_hello(name text) begin
  if name = 'HAL' then
    print('Hello HAL, are you the HAL from 2001 ?');
    return;
  end if;
  print('Hello ' || name || ', nice to meet you');
end say_hello;
say_hello('HAL');
say_hello('Jane Smith');
</pre>


<p id="snippet-basic-function-title" class="snippet">Basic function</p>
<pre id="snippet-basic-function">
var toto integer := 42;
function f(a integer) integer begin
  toto := toto + a;
  return toto + 1;
end f;
print('f(toto): ' || text(f(toto)));
print('expected: 85');
</pre>

<p id="snippet-nested-functions-title" class="snippet">Nested functions</p>
<pre id="snippet-nested-functions">
function add(a integer, b integer) integer begin
  return a + b;
end add;
function double(a integer) integer begin
  var sum integer := add(a, a);
  return sum;
end double;
print('double(3): ' || text(double(3)));
print('expected: 6');
</pre>

<p id="snippet-first-100-primes-title" class="snippet">First 100 Primes</p>
<pre id="snippet-first-100-primes">
var primes_count integer := 100;
function isprime(n integer) boolean begin
  for i in 2 .. n - 1 loop
    if n % i = 0 then
      return false;
    end if;
  end loop;
  return true;
end isprime;
var first_primes [integer] := array(0, primes_count);
begin
  var i integer := 1;
  var index integer := 0;
  while index < primes_count loop
    if isprime(i) then
      first_primes[index] := i;
      index := index + 1;
    end if;
    i := i + 1;
  end loop;
end;
print('first_primes: ' || text(first_primes));
</pre>

<p id="snippet-recursive-facto-title" class="snippet">Recursive Facto</p>
<pre id="snippet-recursive-facto">
function facto(a integer) integer begin
  if a = 0 then
    return 1;
  else
    return a * facto(a - 1);
  end if;
end facto;
print(text(facto(5)));
</pre>

<p id="snippet-fibonacci-title" class="snippet">Fibonacci</p>
<pre id="snippet-fibonacci">
function fibo(n integer) integer begin
  if n = 0 or n = 1 then
    return n;
  else
    return fibo(n - 1) + fibo(n - 2);
  end if;
end fibo;
print(text(fibo(10)));
</pre>

<p id="snippet-bubble-sort-title" class="snippet">Bubble Sort</p>
<pre id="snippet-bubble-sort">
function bubble_sort(nums [integer]) [integer] begin
  for i in reverse 0 .. length(nums) - 2 loop
    for j in 0 .. i loop
      if nums[j] > nums[j + 1] then
        var tmp integer := nums[j];
        nums[j] := nums[j + 1];
        nums[j + 1] := tmp;
      end if;
    end loop;
  end loop;
  return nums;
end bubble_sort;
print(text(bubble_sort([integer: 77, 66, 99, 88, 55, 44, 22, 33,  -22, 11, 0, -11])));
</pre>

<p id="snippet-standard-deviation-title" class="snippet">Standard Deviation</p>
<pre id="snippet-standard-deviation">
function avg(nums [real]) real begin
  var sum real := 0.0;
  for i in 0..length(nums)-1 loop
    sum := sum + nums[i];
  end loop;
  return sum / real(length(nums));
end avg;
function stddev(nums [real]) real begin
  var avg := avg(nums);
  var acc real := 0.0;
  for i in 0..length(nums)-1 loop
  	var diff := nums[i] - avg;
  	acc := acc + diff * diff;
  end loop;
  return sqrt(acc / real(length(nums)));
end stddev;
print(text(stddev([real: 0.0, 1.11, 10.1, 22.33, -6.7])));
print(text(stddev([real: 0.0, 1.0])));
</pre>

<p id="snippet-entropy-title" class="snippet">Entropy</p>
<pre id="snippet-entropy">
function occurence_pos(c integer, occurences [{c integer, n integer}]) integer begin
  for i in 0 .. length(occurences) - 1 loop
    if occurences[i].c = c then
      return i;
    end if;
  end loop;
  return -1;
end occurence_pos;
function char_occurences(t text) [{c integer, n integer}] begin
  var occurences := [{c integer, n integer}:];
  for i in 0 .. length(t) - 1 loop
    var c := char_code(t, i);
    var pos := occurence_pos(c, occurences);
    if pos = - 1 then
      occurences := occurences || [:{c: c, n: 1}];
    else
      occurences[pos].n := occurences[pos].n + 1;
    end if;
  end loop;
  return occurences;
end char_occurences;
function char_entropy(t text) real begin
  var occurences := char_occurences(t);
  var entropy := 0.0;
  for i in 0 .. length(occurences) - 1 loop
    var frequency := real(occurences[i].n) / real(length(t));
    entropy := entropy - frequency * log(frequency) / log(2.0);
  end loop;
  return entropy;
end char_entropy;
print(text(char_entropy('Hello World')));  
print(text(char_entropy('abababababababababab')));
</pre>

<p id="snippet-html-escape-title" class="snippet">Html Escape</p>
<pre id="snippet-html-escape">
function html_escape(t text) text begin
  var esc := '';
  for i in 0..length(t) - 1 loop
    var c := subtext(t, i, 1);
    esc := esc || case c
      when '&gt;'   then '&amp;gt;'
      when '&lt;'   then '&amp;lt'
      when '&amp;'  then '&amp;amp;'
      when '&quot;' then '&amp;quot;'
      else c
    end; 
  end loop;
  return esc;
end html_escape;
print(html_escape('in C bitwise op is & and shift is << or >> (ex: "(a & 0xFF00) >> 8")'));  
</pre>

<p id="snippet-records-title" class="snippet">Records</p>
<pre id="snippet-records">
var r1 {i integer, b boolean} := {i: 42, b: true};
if r1.i = 42 and r1.b then
  print('Good');
else
  print('Error: alternate reality');
end if;
r1.i := 51;
r1.b := false;
if r1.i = 51 and not r1.b then
  print('Good');
else
  print('Error: alternate reality');
end if;
</pre>

<p id="snippet-variant-records-title" class="snippet">Variant Records</p>
<pre id="snippet-variant-records">
# a variant record type automatically create a variable and a function
# for each variant. the variable is numeric, and represents the kind
# of the variant. The function is a constructor for the variant
procedure print(status variant(none, error text, done integer)) begin
  print(kindof status
    when none then 'none'
    when error(msg) then 'error: ' || msg
    when done(row_count) then 'done: ' || text(row_count)
  end);
end print;
var vr variant(none, error text, done integer) := done(5);
print(vr);
vr := none();
print(vr);
vr := error('file not found');
print(vr);
</pre>

<p id="snippet-copy-on-write-title" class="snippet">Copy On Write</p>
<pre id="snippet-copy-on-write">
var v1 := [:[:10, 11], [:20, 21], [:30, 31]];
function text(v [[integer]]) text begin
  var s := '[';
  for i in 0..length(v) - 1 loop
    if i = 0 then
      s := s || text(v[i]);
    else
      s := s || ', ' || text(v[i]);
    end if;
  end loop;
  return s || ']';
end text;
var v2 := v1;
v2[0] := [:42, 51];
var v3 := v1;
v3[1][0] := 42;
var v4 := v1[0];
v4[1] := 43;
print(text(v1));
print(text(v2));
print(text(v3));
print(text(v4));
var v5 := [:1, 2, 3];
procedure change_array(v [integer]) begin
  v[0] := 42;
  v[1] := 51;
  print(text(v));
end change_array;
change_array(v5);
print(text(v5));
procedure change_record(r { a integer, b [integer] }, a integer, b [integer]) begin
  r.a := a;
  r.b := b;
  print('a = ' || text(r.a) || ', b = ' || text(r.b));
end change_record;
var r1 := {a: 1, b: [: 2]};
change_record(r1, 42, [:51]);
print('a = ' || text(r1.a) || ', b = ' || text(r1.b));
</pre>

<p id="snippet-type-inference-title" class="snippet">Type inference</p>
<pre id="snippet-type-inference">
var i := 42;
var b := true;
var v := [:42, 51];
var t := 'Hello';
var r := {i: 42, b: true, v: [:42, 51], t: 'Hello'};
if     i - r.i = 0
   and ((b and r.b) or (not b and not r.b))
   and v[0] - r.v[0] = 0 and v[1] - r.v[1] = 0
   and t || r.t = 'HelloHello'
then
  print('Good');
else
  print('Error: alternate reality');
end if;
</pre>

<p id="snippet-simple-generator-title" class="snippet">Simple Generator</p>
<pre id="snippet-simple-generator">
generator gen_range_step(first integer, last integer, step integer) integer begin
  var current integer := first;
  while current <= last loop
    yield current;
    current := current + step;
  end loop;
end gen_range_step;
for i in gen_range_step(42, 51, 3) loop
  print(text(i));
end loop;
</pre>

<p id="snippet-simple-generator-with-refs-title" class="snippet">Simple Generator With refs</p>
<pre id="snippet-simple-generator-with-refs">
generator gen_concat(words [text], final_int integer) text begin
  var word_count integer := length(words);
  var phrase text := '';
  yield text(word_count);
  for i in 0 .. word_count - 1 loop
    phrase := phrase || words[i];
    yield phrase;
  end loop;
  yield text(final_int);
end gen_concat;
for i in gen_concat([:'hello', ' the', ' world'], 42) loop
  print(i);
end loop;
</pre>

<p id="snippet-generator-html-title" class="snippet">Generator Html</p>
<pre id="snippet-generator-html">
type employee {
  first_name text,
  last_name text,
  skills [text]
};
function employee(first_name text, last_name text, skills [text]) employee begin
  var e employee := {
    first_name: first_name,
    last_name: last_name,
    skills: skills
  };
  return e;
end employee;
generator fetch_employees() employee begin
  yield employee('John', 'Backer', [:'C++', 'SQL']);
  yield employee('Jane', 'Smith', [:'Java', 'HTML']);
  yield employee('Alan', 'Carpenter', [:'Ksh', 'Scrum']);
end fetch_employees;
generator employee_table(with_header boolean, employees sequence(employee)) text begin
  yield '&lt;table&gt;';
  for employee in employees loop
    yield '&lt;tr&gt;&lt;td&gt;' || employee.first_name
       || '&lt;/td&gt;&lt;td&gt;' || employee.last_name
       || '&lt;/td&gt;&lt;td&gt;' || text(employee.skills) || '&lt;/td&gt;&lt;tr&gt;';
  end loop;
  yield '&lt;/table&gt;';
end employee_table;
for html_frag in employee_table(false, fetch_employees()) loop
  print(html_frag);
end loop;
</pre>

<p id="snippet-exception-title" class="snippet">Exception</p>
<pre id="snippet-exception">
const empty_input := 1;
const non_octal_digit := 2;
function parse_octal(t text) integer begin
  if length(t) = 0 then
    raise empty_input;
  end if;
  var code0 := char_code('0', 0);
  var num := 0;
  for i in 0..length(t) - 1 loop
    var digit := char_code(t, i) - code0;
    if digit < 0 or digit > 7 then
      raise non_octal_digit;
    end if;
    num := num * 8 + digit;
  end loop;
  return num;
end parse_octal;
procedure print_test_result(input text, result integer, is_result_exception boolean, expected integer, is_expected_exception boolean) begin
  var result_text := text(result);
  if is_result_exception then
    result_text := 'exception(' || text(result) || ')';
  end if;
  var expected_text := text(expected);
  if is_expected_exception then
    expected_text := 'exception(' || text(expected) || ')';
  end if;
  var status := 'FAILED';
  if result = expected and is_result_exception = is_expected_exception then
    status := 'OK';
  end if;
  print('Test ' || status || ' for ' || input || ' got ' || result_text || ', expected ' || expected_text);
  if input = 'Darth Vader' then
    raise 54;
  end if;
end print_test_result;
procedure test_parse_octal(t text, expected_result integer, expected_exception boolean) begin
  var num := parse_octal(t);
  print_test_result(t, num, false, expected_result, expected_exception);
exception
  when empty_input then
  	print_test_result(t, empty_input, true, expected_result, expected_exception);
  when non_octal_digit then
  	print_test_result(t, non_octal_digit, true, expected_result, expected_exception);
end test_parse_octal;      
begin
  test_parse_octal('', empty_input, true);
  test_parse_octal('abc', non_octal_digit, true);
  test_parse_octal('12345678', non_octal_digit, true);
  test_parse_octal('0', 0, false);
  test_parse_octal('10', 8, false);
  test_parse_octal('31337', 31337, false);
  test_parse_octal('1234567', 1234567, false);
  test_parse_octal('Darth Vader', non_octal_digit, true);
exception
  else
    print('easter egg exception');   
end;
</pre>

<script>fillSnippetSelect()</script>
</body></html>
