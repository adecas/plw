<!DOCTYPE html>
<meta charset="UTF-8">
<html>
<head>
<title>IR Test</title>
<script src="PlwOpcodes.js"></script>
<script src="PlwCodeBlock.js"></script>
<script src="PlwIR.js"></script>
</head>
<body>
<textarea id="output" cols="100" rows="25"></textarea>
<script>

function hexDumpToByteArray(dump) {	
	let parsedDump = [];
	let lines = dump.split("\n");
	for (let i = 0; i < lines.length; i++) {
		let line = lines[i].trim();
		let colonPos = line.indexOf(":");
		if (colonPos !== -1) {
			line = line.substring(colonPos + 1);
			let words = line.split(" ");
			for (let j = 0; j < words.length; j++) {
				let word = words[j].trim();
				if (word.length >= 2) {
					parsedDump[parsedDump.length] = parseInt(word.substring(0, 2), 16);
				}
				if (word.length >= 4) {
					parsedDump[parsedDump.length] = parseInt(word.substring(2, 4), 16);
				}
			}
		}
	}
	return new Uint8Array(parsedDump);
}

const PLW_RT_MODULE = hexDumpToByteArray(`
0000000: 0061 736d 0100 0000 0118 0560 017f 017f 
0000010: 6000 017f 6002 7f7f 0060 017f 0060 017e 
0000020: 017f 0314 1300 0100 0200 0200 0200 0200 
0000030: 0303 0000 0304 0300 0503 0100 0106 0b02 
0000040: 7f01 4108 0b7f 0141 080b 0776 0906 6d65 
0000050: 6d6f 7279 0200 124d 454d 5f66 6972 7374 
0000060: 4672 6565 426c 6f63 6b03 000d 4d45 4d5f 
0000070: 6c61 7374 426c 6f63 6b03 0108 4d45 4d5f 
0000080: 696e 6974 000c 094d 454d 5f61 6c6c 6f63 
0000090: 000e 084d 454d 5f66 7265 6500 0f0a 5245 
00000a0: 465f 6372 6561 7465 0010 0952 4546 5f69 
00000b0: 6e63 5263 0011 0952 4546 5f64 6563 5263 
00000c0: 0012 0ad2 0613 0a00 4107 2000 6a41 7871 
00000d0: 0b04 0041 100b 0700 2000 2802 000b 0900 
00000e0: 2000 2001 3602 000b 0a00 2000 4104 6a28 
00000f0: 0200 0b0c 0020 0041 046a 2001 3602 000b 
0000100: 0a00 2000 4108 6a28 0200 0b0c 0020 0041 
0000110: 086a 2001 3602 000b 0a00 2000 410c 6a28 
0000120: 0200 0b0c 0020 0041 0c6a 2001 3602 000b 
0000130: 0900 2000 1006 417f 460b 0800 2000 417f 
0000140: 1007 0b2a 0020 0024 0020 0024 0123 003f 
0000150: 0041 8080 046c 2300 6b10 0323 0041 0010 
0000160: 0523 0041 0010 0723 0041 0010 090b 2e01 
0000170: 027f 2000 1001 6a21 0123 0021 0202 4020 
0000180: 0245 0440 0c01 0b20 0120 0210 024d 0440 
0000190: 0c01 0b20 0210 0821 020b 2002 0bd1 0101 
00001a0: 077f 2000 4504 4041 000f 0b20 0010 0021 
00001b0: 0020 0010 0d21 0120 0145 0440 000b 2001 
00001c0: 1002 2102 2001 1006 2103 2001 1008 2104 
00001d0: 2001 100b 2002 2000 1001 4104 6c6a 4a04 
00001e0: 4020 0120 0010 016a 1003 2001 2001 1002 
00001f0: 6a21 0520 0520 0220 0110 026b 1003 2005 
0000200: 2001 1005 2005 2003 1007 2005 2004 1009 
0000210: 2003 4504 4020 0524 0005 2003 2005 1009 
0000220: 0b20 0441 0047 0440 2004 2005 1007 0b20 
0000230: 0123 0146 0440 2005 2401 0520 0120 026a 
0000240: 2106 2006 2005 1005 0b05 2003 4504 4020 
0000250: 0424 0005 2003 2004 1009 0b20 0441 004a 
0000260: 0440 2004 2003 1007 0b0b 2001 1001 6a0b 
0000270: d502 010a 7f20 0010 016b 2101 2001 1002 
0000280: 2102 2001 1004 2103 4100 2104 2003 4100 
0000290: 4704 4020 0310 0a45 0440 4101 2104 0b0b 
00002a0: 2001 2002 6a21 0541 0021 0620 0541 0047 
00002b0: 0440 2005 100a 4504 4041 0121 060b 0b20 
00002c0: 0404 4020 0604 4020 0510 0221 0720 0520 
00002d0: 076a 2108 2003 2003 1002 2002 2007 6a6a 
00002e0: 1003 2005 2301 4604 4020 0324 0105 2008 
00002f0: 2003 1005 0b20 0510 0621 0920 0510 0821 
0000300: 0a20 0945 0440 200a 2400 0520 0920 0a10 
0000310: 090b 200a 4100 4704 4020 0a20 0910 070b 
0000320: 0520 0320 0310 0220 026a 1003 2001 2301 
0000330: 4604 4020 0324 0105 2005 2003 1005 0b0b 
0000340: 0520 0604 4020 0510 0221 0720 0520 076a 
0000350: 2108 2005 1006 2109 2005 1008 210a 2001 
0000360: 2002 2007 6a10 0320 0120 0910 0720 0120 
0000370: 0a10 0920 0523 0146 0440 2001 2401 0520 
0000380: 0820 0110 050b 2009 4504 4020 0124 0005 
0000390: 2009 2001 1009 0b20 0a41 0047 0440 200a 
00003a0: 2001 1007 0b05 2001 4100 1007 2001 2300 
00003b0: 1009 2300 4100 4704 4023 0020 0110 070b 
00003c0: 2001 2400 0b0b 0b17 0101 7f20 00a7 100e 
00003d0: 2101 2001 4104 6b41 0136 0200 2001 0b18 
00003e0: 0101 7f20 0041 046b 2101 2001 2001 2802 
00003f0: 0041 016a 3602 000b 1e01 027f 2000 4104 
0000400: 6b21 0120 0128 0200 4101 6a21 0220 0120 
0000410: 0236 0200 2002 0b                       
`);

function printLog(text) {
	document.getElementById("output").value += "" + text + "\n";
}

function printMemDump(rtModuleInstance) {
	let mem = new Uint32Array(rtModuleInstance.exports.memory.buffer);
	let firstFreeBlock = rtModuleInstance.exports.MEM_firstFreeBlock;
	let lastBlock = rtModuleInstance.exports.MEM_lastBlock;
	
	printLog("=== DUMP ==========================================");
	printLog("");
	printLog("First free block: " + firstFreeBlock);
	printLog("Last block: " + lastBlock);
	printLog("");
	let b = 2;
	let totalBlockSize = 0;
	while (b <= lastBlock) {
		let size = mem[b];
		let prev = mem[b + 1];
		let prevFree = mem[b + 2];
		let nextFree = mem[b + 3];
		totalBlockSize += size;
		if (prevFree === 0xFFFFFFFF) {
			printLog("" + (b << 2) + ": used: size " + size + ", prev " + prev +
					", ptr " + ((b << 2) + 16));
		} else {
			printLog("" + (b << 2) + ": free: size " + size + ", prev " + prev +
					", prevFree " + prevFree + ", nextFree " + nextFree);
		}
		b += size >> 2;
	}
	printLog("");
	printLog("Total Block Size: " + totalBlockSize);
	printLog("");
}



let irFuncs = [];

function addIrFunc(f) {
	let i = irFuncs.length;
	irFuncs[i] = f;
	return i;
}


const IRF_PrintI64 = addIrFunc(new PlwIRFunction("printI64", "stdlib", 1, [], [PLW_IR_TYPE_I64], null));
const IRF_PrintI32 = addIrFunc(new PlwIRFunction("printI32", "stdlib", 1, [], [PLW_IR_TYPE_I32], null));

const IRF_Swap = addIrFunc(new PlwIRFunction(
	"swap",
	null,
	2,
	[PLW_IR_TYPE_I64, PLW_IR_TYPE_I64],
	[PLW_IR_TYPE_I64, PLW_IR_TYPE_I64],
	new PlwIRBlock([
		new PlwIRSetLocal([0], new PlwIRBinOp(PLW_IR_OP_I64_ADD, new PlwIRLocal(0), new PlwIRLocal(1))),		
		new PlwIRReturn([
			new PlwIRLocal(1),
			new PlwIRLocal(0)
		])
	])
));

const IRF_Main1 = addIrFunc(new PlwIRFunction("main", null, 0, [], [PLW_IR_TYPE_PTR],
	PlwIR.block([
		PlwIR.setLocal([0], PlwIR.alloc(PlwIR.i32(57))),
		PlwIR.storeI64(PlwIR.local(0), PlwIR.i32(0), PlwIR.i64(42)),
		PlwIR.callf(IRF_PrintI64, [PlwIR.loadI64(PlwIR.local(0), PlwIR.i32(0))]),
		PlwIR.ret([])
	])
));

const IRF_Main = addIrFunc(new PlwIRFunction("main2", null, 0, [], [PLW_IR_TYPE_PTR],
	PlwIR.block([
		PlwIR.callf(IRF_PrintI64, [PlwIR.global(0)]),
		PlwIR.ret([])
	])
));

const IRF_Facto = addIrFunc(new PlwIRFunction (
	"facto",
	null,
	1,
	[PLW_IR_TYPE_I64],
	[PLW_IR_TYPE_I64],
	new PlwIRBlock([
		new PlwIRIf(new PlwIRBinOp(PLW_IR_OP_I64_EQ, new PlwIRLocal(0), new PlwIRI64(0)),
			new PlwIRReturn([new PlwIRI64(1)]),
			null
		),
		new PlwIRReturn([
			new PlwIRBinOp(PLW_IR_OP_I64_MUL,
				new PlwIRLocal(0),
				new PlwIRCall(3, [
					new PlwIRBinOp(PLW_IR_OP_I64_SUB,
						new PlwIRLocal(0),
						new PlwIRI64(1)
					)
				])
			)
		])
	])
));

const IRF_FactoIter = addIrFunc(new PlwIRFunction (
	"factoiter",
	null,
	1,
	[PLW_IR_TYPE_I64],
	[PLW_IR_TYPE_I64, PLW_IR_TYPE_I64],
	new PlwIRBlock([
		new PlwIRSetLocal([1], new PlwIRI64(1)),
		new PlwIRLoop(new PlwIRBlock([
			new PlwIRIf(new PlwIRBinOp(PLW_IR_OP_I64_LT, new PlwIRLocal(0), new PlwIRI64(2)), new PlwIRExitLoop(), null),
			new PlwIRSetLocal([1], new PlwIRBinOp(PLW_IR_OP_I64_MUL, new PlwIRLocal(1), new PlwIRLocal(0))),
			new PlwIRSetLocal([0], new PlwIRBinOp(PLW_IR_OP_I64_SUB, new PlwIRLocal(0), new PlwIRI64(1)))
		])),
		new PlwIRReturn([new PlwIRLocal(1)])
	])
));

let irGlobals = [
	PLW_IR_TYPE_I64
];

let testIRModule = new PlwIRModule("test", irGlobals, irFuncs);
	
// console.log(JSON.stringify(testIRModule));

let compiler = new PlwIRWasmCompiler(testIRModule);
compiler.compileModule();
let bytes = compiler.moduleBytes();

// console.log(JSON.stringify(compiler, true));

// for (let i = 0; i < bytes.length; i++) {
//	console.log("" + i + ": " + bytes[i]);
// }

class PlwStdlib {
	
	printI32(i) {
		console.log("" + i);
	}
	
	printI64(i) {
		console.log("" + i);
	}
}


WebAssembly.instantiate(PLW_RT_MODULE).then((plwruntime) => {
	plwruntime.instance.exports.MEM_init(8);
	let importObject = {
		"plwruntime": plwruntime.instance.exports,
		"stdlib": new PlwStdlib(),
		"plwnative": {
			"print(text)": 	function(ptr) {
				let mem = new Uint32Array(plwruntime.instance.exports.memory.buffer);
				ptr = ptr / 4;
				let len = mem[ptr];
				let codes = mem.slice(ptr + 1, ptr + 1 + len);
				printTextOut(String.fromCharCode(...codes));
			}
		}
	};
	WebAssembly.instantiate(new Uint8Array(bytes), importObject).then((module) => {
		module.instance.exports.main();
		printMemDump(plwruntime.instance);
	});
});

</script>
</body>
